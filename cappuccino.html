<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversion Page with Performance Monitor</title>

    <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_GOOGLE_TAG_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'YOUR_GOOGLE_TAG_ID');
    </script>

    <script>
      !function(f,b,e,v,n,t,s)
      {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
      
      fbq('init', 'YOUR_FACEBOOK_PIXEL_ID');
      fbq('track', 'PageView');
    </script>
    <noscript>
      <img height="1" width="1" style="display:none" 
           src="https://www.facebook.com/tr?id=YOUR_FACEBOOK_PIXEL_ID&ev=PageView&noscript=1"/>
    </noscript>
    
    <style>
        /* Simple styling for the debug box */
        #debug-panel {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            font-family: monospace;
        }
        .found { color: green; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Conversion & Performance Test Page</h1>
    <p>The system is monitoring network requests for Google and Facebook tags...</p>

    <div id="debug-panel">
        <h3>Performance API Log:</h3>
        <ul id="request-log"></ul>
    </div>

    <script>
        // formatting helper
        const logList = document.getElementById('request-log');
        function logMessage(msg, isMatch) {
            const li = document.createElement('li');
            li.textContent = msg;
            if (isMatch) li.className = 'found';
            logList.appendChild(li);
        }

        // Define the domains we want to watch for
        const targets = ['googletagmanager.com', 'facebook.net'];

        // Create a PerformanceObserver to watch for "resource" entries
        // This detects scripts, images, and fetch/xhr requests
        const observer = new PerformanceObserver((list) => {
            list.getEntries().forEach((entry) => {
                
                // Check if the entry URL contains our target domains
                targets.forEach(domain => {
                    if (entry.name.includes(domain)) {
                        logMessage(`[DETECTED] Request made to: ${domain}`, true);
                        console.log('Full URL:', entry.name); // Log full details to console
                    }
                });

            });
        });

        // Start observing. 
        // buffered: true is CRITICAL. It ensures we catch requests 
        // that happened before this script loaded.
        observer.observe({ type: 'resource', buffered: true });
        
        // Optional: Notify if nothing is found after a few seconds
        setTimeout(() => {
            if (logList.children.length === 0) {
                logMessage("No matching requests detected yet.", false);
            }
        }, 3000);
    </script>

    <div class="counter-box">
        Current Count: <span id="count-display">Loading...</span>
    </div>

    <script>
        // 1. Define the key we will use in LocalStorage
        const STORAGE_KEY = 'userCounter';

        // 2. Select the HTML element where we will show the number
        const displayElement = document.getElementById('count-display');

        // 3. Get the current value from LocalStorage
        // Note: LocalStorage always returns a String or null
        let storedValue = localStorage.getItem(STORAGE_KEY);

        let finalCount;

        // 4. Check logic: Does the counter exist?
        if (storedValue === null) {
            // CASE A: Counter does not exist yet
            finalCount = 0;
        } else {
            // CASE B: Counter exists
            // We must convert the string back to a number to do math
            finalCount = parseInt(storedValue) + 1;
        }

        // 5. Update the display in the HTML
        displayElement.innerText = finalCount;

        // 6. Save the new value back to LocalStorage
        localStorage.setItem(STORAGE_KEY, finalCount);
        
        console.log(`Counter updated to: ${finalCount}`);
    </script>
</body>
</html>
